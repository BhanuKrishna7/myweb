pipeline {
    agent any

    environment {
        // Repository & Build Details
        GIT_REPO = 'https://github.com/BhanuKrishna7/myweb.git'
        BRANCH   = 'master'
        WAR_NAME = 'myweb-8.2.0.war'

        // SonarQube
        SONARQUBE_SERVER = 'SonarQube'

        // Nexus Details
        NEXUS_URL  = 'http://18.217.35.125:8081'
        NEXUS_REPO = 'sample-releases'
        NEXUS_CRED = 'nexus-creds'

        GROUP_ID    = 'in.javahome'
        ARTIFACT_ID = 'myweb'
        VERSION     = '8.2.0'
        PACKAGING   = 'war'

        // Remote Server Details
        TOMCAT_HOST = '172.31.10.32'
        TOMCAT_USER = 'ec2-user'
        TOMCAT_PATH = '/home/ec2-user/tomcat/webapps'
        SSH_CRED_ID = 'SSH'
    }

    stages {

        stage('Checkout Code') {
            steps {
                echo 'üîπ Cloning Git repository...'
                git branch: "${BRANCH}", url: "${GIT_REPO}"
            }
        }

        stage('Build with Maven') {
            steps {
                echo 'üîπ Running Maven Clean and Package...'
                sh 'mvn clean package -DskipTests'
            }
        }

        stage('SonarQube Analysis') {
            steps {
                echo 'üîç Running SonarQube analysis...'
                withSonarQubeEnv("${SONARQUBE_SERVER}") {
                    sh 'mvn sonar:sonar'
                }
            }
        }

        stage('Upload WAR to Nexus') {
            steps {
                echo 'üì§ Uploading WAR to Nexus...'
                withCredentials([usernamePassword(
                        credentialsId: "${NEXUS_CRED}",
                        usernameVariable: 'NEXUS_USER',
                        passwordVariable: 'NEXUS_PASS'
                )]) {
                    sh """
                    mvn deploy:deploy-file \
                      -DgroupId=${GROUP_ID} \
                      -DartifactId=${ARTIFACT_ID} \
                      -Dversion=${VERSION} \
                      -Dpackaging=${PACKAGING} \
                      -Dfile=target/${WAR_NAME} \
                      -DrepositoryId=nexus \
                      -Durl=${NEXUS_URL}/repository/${NEXUS_REPO} \
                      -Dusername=${NEXUS_USER} \
                      -Dpassword=${NEXUS_PASS}
                    """
                }
            }
        }

        stage('Stop Tomcat Service') {
            steps {
                echo 'üõë Stopping Tomcat service before deployment...'
                sshagent (credentials: ["${SSH_CRED_ID}"]) {
                    sh """
                       ssh -o StrictHostKeyChecking=no \
                       ${TOMCAT_USER}@${TOMCAT_HOST} \
                       /home/ec2-user/tomcat/bin/shutdown.sh || true
                    """
                }
            }
        }

        stage('Copy WAR to Remote Server') {
            steps {
                echo 'üì¶ Copying WAR file to Tomcat webapps directory...'
                sshagent (credentials: ["${SSH_CRED_ID}"]) {
                    sh """
                        scp -o StrictHostKeyChecking=no \
                        target/${WAR_NAME} \
                        ${TOMCAT_USER}@${TOMCAT_HOST}:${TOMCAT_PATH}/
                    """
                }
            }
        }

        stage('Start Tomcat Service') {
            steps {
                echo 'üöÄ Starting Tomcat service after deployment...'
                sshagent (credentials: ["${SSH_CRED_ID}"]) {
                    sh """
                        ssh -o StrictHostKeyChecking=no \
                        ${TOMCAT_USER}@${TOMCAT_HOST} \
                        /home/ec2-user/tomcat/bin/startup.sh
                    """
                }
            }
        }
    }

    post {
        success {
            echo '‚úÖ SonarQube, Nexus publish & deployment completed successfully!'
        }
        failure {
            echo '‚ùå Pipeline failed. Check Jenkins logs for details.'
        }
    }
}
