pipeline {
    agent any

    environment {
        // Repository & Build Details
        GIT_REPO = 'https://github.com/BhanuKrishna7/myweb.git'
        BRANCH = 'master'
        WAR_NAME = 'myweb-8.2.0.war'

        // Remote Server Details
        TOMCAT_HOST = '172.31.16.111'
        TOMCAT_USER = 'ec2-user'   // or ubuntu, centos, etc.
        TOMCAT_PATH = '/home/ec2-user/apache-tomcat-9.0.111/webapps'
        SSH_CRED_ID = 'SSH'  // Jenkins credential ID (SSH key)
    }

    stages {
        stage('Checkout Code') {
            steps {
                echo 'üîπ Cloning Git repository...'
                git branch: "${BRANCH}", url: "${GIT_REPO}"
            }
        }

        stage('Build with Maven') {
            steps {
                echo 'üîπ Running Maven Clean and Package...'
                sh 'mvn clean package -DskipTests'
            }
        }

        stage('Stop Tomcat Service') {
            steps {
                echo 'üõë Stopping Tomcat service before deployment...'
                sshagent (credentials: ["${SSH_CRED_ID}"]) {
                    sh """
                        ssh -o StrictHostKeyChecking=no ${TOMCAT_USER}@${TOMCAT_HOST} '
                            echo "Stopping Tomcat...";
                            sudo systemctl stop tomcat || true;
                            sleep 5;
                            sudo systemctl status tomcat --no-pager || true;
                        '
                    """
                }
            }
        }

        stage('Copy WAR to Remote Server') {
            steps {
                echo 'üì¶ Copying WAR file to Tomcat webapps directory...'
                sshagent (credentials: ["${SSH_CRED_ID}"]) {
                    sh """
                        scp -o StrictHostKeyChecking=no target/${WAR_NAME} \
                        ${TOMCAT_USER}@${TOMCAT_HOST}:${TOMCAT_PATH}/
                    """
                }
            }
        }

        stage('Start Tomcat Service') {
            steps {
                echo 'üöÄ Starting Tomcat service after deployment...'
                sshagent (credentials: ["${SSH_CRED_ID}"]) {
                    sh """
                        echo "Stopping Tomcat...";
                        ssh ${TOMCAT_USER}@${TOMCAT_HOST} /home/ec2-user/apache-tomcat-9.0.111/bin/shutdown.sh
                        echo "Starting Tomcat...";
                        ssh ${TOMCAT_USER}@${TOMCAT_HOST} /home/ec2-user/apache-tomcat-9.0.111/bin/startup.sh
                    """
                }
            }
        }
    }

    post {
        success {
            echo '‚úÖ Deployment completed successfully!'
        }
        failure {
            echo '‚ùå Deployment failed. Check the Jenkins logs for details.'
        }
    }
}
